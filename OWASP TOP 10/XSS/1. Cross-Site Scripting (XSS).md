# Vulnerabilidad XSS (Cross-Site Scripting)

## ¿Qué es un ataque XSS?

> XSS (Cross-Site Scripting) es una vulnerabilidad de seguridad que permite a un atacante inyectar código malicioso en una página web. Cuando un usuario visita la página afectada, su navegador ejecuta el código sin darse cuenta. Esto puede permitir el robo de datos personales, como credenciales de acceso o información sensible.

## ¿Cómo funciona?

El atacante inserta código malicioso (generalmente JavaScript) en un sitio web vulnerable. Cuando otro usuario accede a la página, el código se ejecuta en su navegador sin que lo note. Dependiendo del ataque, esto puede usarse para:

- Robar cookies de sesión.
    
- Registrar pulsaciones de teclas.
    
- Redirigir a páginas falsas para robar credenciales.
    
- Mostrar contenido fraudulento.
    

## Tipos de XSS

1. **XSS Reflejado (Reflected XSS)**
    
    - Ocurre cuando el sitio web incluye datos proporcionados por el usuario en la respuesta sin validarlos correctamente.
        
    - Un atacante engaña a la víctima para que haga clic en un enlace que contiene código malicioso.
        
2. **XSS Almacenado (Stored XSS)**
    
    - El código malicioso se guarda en la base de datos del sitio web.
        
    - Cada vez que un usuario carga la página, el código se ejecuta en su navegador.
        
3. **XSS basado en DOM (DOM-Based XSS)**
    
    - La inyección ocurre dentro del navegador del usuario, cuando el JavaScript del sitio web manipula el DOM de forma insegura.
        
    - No necesita interacción directa con el servidor.
        

## ¿Cómo prevenir XSS?

Para evitar ataques XSS, los desarrolladores deben:

- **Validar y sanitizar** todos los datos de entrada del usuario.
    
- **Escapar caracteres especiales** para evitar la ejecución de scripts (`<`, `>`, `'`, `"`, `&`).
    
- **Utilizar Content Security Policy (CSP)** para restringir la ejecución de scripts no autorizados.
    
- **Evitar el uso de `innerHTML`** en JavaScript y usar alternativas más seguras como `textContent`.
    

XSS es una vulnerabilidad común, pero con buenas prácticas de seguridad puede prevenirse de manera efectiva.

---
# XSS: Análisis del payload 

```bash
#"><img src=/ onerror=alert(document.cookie)>
```

## Contexto

Cuando intentamos explotar una vulnerabilidad **XSS (Cross-Site Scripting)**, necesitamos **inyectar código JavaScript malicioso** en una aplicación vulnerable para que se ejecute en el navegador de otro usuario.

Aunque muchas personas comienzan probando con etiquetas `<script>`, no siempre funcionan debido a filtros o restricciones del lado del servidor. Por eso, se utilizan otras etiquetas HTML que **permiten ejecutar código JavaScript a través de eventos como `onerror` o `onclick`**.

---

## Payload: 

```bash
#"><img src=/ onerror=alert(document.cookie)>
```

### Análisis paso a paso

1. **`#"`**  
   - Esto **cierra un atributo HTML anterior**, como el valor de un `href`, `src` o `value`.  
   - Ejemplo: Si el HTML contiene `<a href="pagina.php?var=...">`, este `"` termina el valor abierto y **rompe la estructura del HTML**.

2. **`>`**  
   - Cierra la etiqueta HTML actual.  
   - Importante para **salir de un contexto de atributo o etiqueta mal formada**.

3. **`<img src=/ onerror=alert(document.cookie)>`**  
   - Se inserta una etiqueta `<img>` con una ruta inválida (`src=/`) que **forzará un error de carga**.
   - El atributo `onerror` se activa cuando la imagen falla, y ejecuta `alert(document.cookie)`.

---

## ¿Por qué no funciona `<script> ... </script>`?

###  Casos en que **no** funciona `<script>`:
- Muchos filtros **detectan directamente** la cadena `<script>` y la bloquean.
- Algunos motores de plantilla (como Twig, Jinja2, etc.) o CMS **escapan automáticamente las etiquetas `<script>`**.
- Sistemas de seguridad como **WAFs** o validaciones del lado del servidor **limitan etiquetas consideradas críticas** como `<script>`.

### Alternativa: eventos en etiquetas "inofensivas"
- Etiquetas como `<img>`, `<svg>`, `<iframe>`, `<a>` **no están tan bloqueadas** o **pasan desapercibidas** en validaciones básicas.
- Aprovechamos sus atributos **event handlers** (`onerror`, `onload`, `onclick`, etc.) para ejecutar JavaScript sin necesidad de usar `<script>`.

---

## Conclusión

Este payload funciona porque:
- Rompe el contexto HTML existente (con `"` y `>`).
- Inyecta una etiqueta `<img>` "aparentemente inofensiva".
- Usa un atributo `onerror` para **ejecutar código malicioso** al fallar la carga de imagen.
- **Evita filtros básicos** que buscan directamente la etiqueta `<script>`.

---

## Tip: Otros eventos comunes para bypass XSS

```html
<svg onload=alert(1)>
<iframe src="javascript:alert(1)">
<a href="javascript:alert(1)">Click</a>
<video><source onerror="alert(1)">
````

---

## Ejemplo visual (HTML vulnerable)

```html
<!-- Código vulnerable del lado del servidor -->
<p>Bienvenido, <?php echo $_GET['nombre']; ?></p>

<!-- URL maliciosa -->
http://victima.com/?nombre=#"><img src=/ onerror=alert(document.cookie)>
```

Resultado:

```html
<p>Bienvenido, #"><img src=/ onerror=alert(document.cookie)></p>
```

- Se rompe el HTML y se ejecuta el `alert()` cuando el navegador intenta cargar una imagen inválida.

---
