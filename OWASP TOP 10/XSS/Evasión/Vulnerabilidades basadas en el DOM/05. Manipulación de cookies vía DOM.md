
---

# Manipulación de cookies vía DOM

## Introducción

En este laboratorio analizamos una vulnerabilidad de **DOM-based XSS** provocada por la **manipulación de cookies en el lado cliente**. La aplicación almacena en una cookie llamada `lastViewedProduct` la URL del último producto visitado y posteriormente reutiliza ese valor dentro del DOM sin realizar ningún tipo de validación o saneado.

Esto permite a un atacante inyectar contenido malicioso en la cookie y lograr su ejecución cuando la víctima carga otra página que hace uso de dicho valor.

[Ver laboratorio PortSwigger](https://portswigger.net/web-security/dom-based/cookie-manipulation/lab-dom-cookie-manipulation)

## ¿En qué consiste esta vulnerabilidad?

La vulnerabilidad se basa en una **confianza indebida en datos almacenados en cookies**, asumiendo que su contenido es seguro por haber sido generado previamente por la propia aplicación.

En este laboratorio ocurre lo siguiente:

1. El navegador guarda en la cookie `lastViewedProduct` la URL del último producto visitado.
    
2. Esa cookie es controlable indirectamente por el usuario.
    
3. El valor de la cookie se inserta posteriormente en el DOM.
    
4. No se realiza ninguna validación ni codificación del contenido.
    

Como resultado, es posible inyectar código JavaScript que se ejecutará en el contexto del dominio vulnerable.

## Flujo funcional vulnerable

El comportamiento vulnerable se observa en la sección de navegación superior de la página:

```html
<section class="top-links">
    <a href=/>Home</a><p>|</p>
    <a href='https://LAB-ID.web-security-academy.net/product?productId=1'>Last viewed product</a><p>|</p>
</section>
```

El enlace **Last viewed product** utiliza directamente el valor almacenado en la cookie `lastViewedProduct` para construir el atributo `href`.

## Identificación del punto de inyección

Mediante la interceptación de la petición con Burp Suite observamos la cookie vulnerable:

```
Cookie: session=...; lastViewedProduct=https://LAB-ID.web-security-academy.net/product?productId=1
```

Al manipular el valor de esta cookie, comprobamos que su contenido se refleja sin escapado en el DOM, permitiendo romper el contexto HTML.

Un ejemplo de inyección visible es el siguiente:

```html
<section class="top-links">
    <a href=/>Home</a><p>|</p>
    <a href='https://LAB-ID.web-security-academy.net/product?productId=1&'/><h1>Probando</h1>'>Last viewed product</a><p>|</p>
</section>
```

Esto confirma que el valor de la cookie es **directamente inyectable**.

## ¿Cómo se resuelve el laboratorio?

La explotación requiere dos pasos coordinados desde el servidor de explotación:

1. Forzar a la víctima a visitar una URL de producto con un payload XSS embebido.
    
2. Redirigir inmediatamente a la víctima a la página principal.
    

Cuando se visita la página de producto maliciosa:

- El navegador guarda la URL completa en la cookie `lastViewedProduct`.
    
- El payload queda almacenado en la cookie.
    

Al cargarse posteriormente la página principal:

- La aplicación lee la cookie.
    
- Inserta su contenido en el DOM.
    
- El navegador interpreta y ejecuta el JavaScript inyectado.
    

## Payload utilizado

El payload que resuelve el laboratorio es el siguiente:

```html
<iframe src="https://LAB-ID.web-security-academy.net/product?productId=1&'><script>print()</script>"
        onload="if(!window.x)this.src='https://LAB-ID.web-security-academy.net';window.x=1;">
</iframe>
```

Desglose del payload:

- La URL del producto contiene un cierre de atributo seguido de un `<script>`.
    
- El navegador almacena esta URL en la cookie `lastViewedProduct`.
    
- El `onload` redirige inmediatamente a la página principal.
    
- El usuario no percibe el ataque.
    

## ¿Por qué funciona el ataque?

El ataque es efectivo porque:

- Las cookies del lado cliente son completamente controlables.
    
- No existe validación ni codificación al reutilizar su valor.
    
- El DOM interpreta el contenido como HTML.
    
- El payload se ejecuta en una página distinta a la de inyección.
    

Esto convierte la cookie en un **vector persistente de XSS DOM**.

## Riesgos asociados

Una vulnerabilidad de este tipo puede permitir:

- Ejecución persistente de JavaScript.
    
- Robo de información accesible desde el DOM.
    
- Suplantación de acciones del usuario.
    
- Encadenamiento con otras vulnerabilidades del lado cliente.
    

En aplicaciones reales, este patrón suele tener **impacto crítico**.

## Mitigaciones recomendadas

Para prevenir este tipo de vulnerabilidades se recomienda:

- No confiar nunca en el contenido de cookies del lado cliente.
    
- Codificar correctamente cualquier dato insertado en el DOM.
    
- Evitar almacenar URLs completas controlables por el usuario.
    
- Usar identificadores internos en lugar de valores directos.
    
- Implementar una Content Security Policy restrictiva.
    

Este laboratorio demuestra que **almacenar datos no confiables en cookies puede convertirlos en vectores de ataque persistentes**.

---
