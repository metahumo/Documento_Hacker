
---

# CSRF sin defensas: Cambio de correo electrónico

## 1. Introducción

En este laboratorio trabajamos con un caso básico de vulnerabilidad **Cross-Site Request Forgery (CSRF)** donde una funcionalidad sensible —el cambio de correo electrónico del usuario— carece por completo de mecanismos de protección. 

Esto hace posible que un atacante fuerce acciones en la cuenta de un usuario autenticado simplemente consiguiendo que visite una página con un formulario oculto y autoenviado.

Este escenario representa el nivel más sencillo de explotación de CSRF, y nos sirve como base para comprender cómo funcionan las variantes modernas que incluyen validaciones adicionales como tokens anti-CSRF, cabeceras personalizadas o restricciones del origen.

[Ver laboratorio Portswigger](https://portswigger.net/web-security/csrf/lab-no-defenses)

---

## 2. Contexto de la vulnerabilidad

La aplicación contiene una funcionalidad para actualizar el correo electrónico del usuario mediante una petición **POST**.  
Esta petición **no implementa**:

- Token anti-CSRF (`CSRF token`)
    
- Restricciones de método (como `SameSite`)
    
- Validación de cabeceras (como `Origin` o `Referer`)
    
- Limitaciones en el contenido de origen
    

Por ello, cualquier sitio externo puede enviar peticiones autenticadas en nombre del usuario objetivo, mientras su sesión siga activa en el navegador.

---

## 3. Técnica de explotación

La clave está en **reproducir la misma petición POST** que la funcionalidad legítima, pero desde una página controlada por el atacante.

Para lograrlo:

1. Creamos un formulario HTML que envía los mismos parámetros.
    
2. Lo ocultamos para no mostrar nada a la víctima.
    
3. Insertamos un pequeño script que autoenvía el formulario al cargar la página.
    

De esta manera, cuando la víctima visita el enlace malicioso, desencadena la acción sin interacción y usando sus propias cookies de sesión.

---

## 4. Procedimiento paso a paso

### 4.1 Obtener la petición legítima

1. Abrimos el navegador con Burp y nos autenticamos en la aplicación.
    
2. Enviamos el formulario de cambio de correo.
    
3. Localizamos la petición en el historial del proxy.
    

> Si usamos Burp Professional, podemos generar automáticamente el exploit desde  
> **Engagement tools → Generate CSRF PoC**, activando la opción de auto-submit.

---

### 4.2 Construcción manual del exploit (Community Edition)

Plantilla HTML base para enviar el correo malicioso:

```html
<form class="login-form" name="change-email-form" action="https://<host>/my-account/change-email" method="POST">
    <input type="hidden" name="email" value="pwned@hacked.com">
</form>

<script>
    document.forms[0].submit();
</script>
```

Puntos clave:

- Ajustamos `<host>` según el laboratorio.
    
- Ocultamos el formulario (aunque no es obligatorio aquí).
    
- El script ejecuta automáticamente la petición POST.
    

---

### 4.3 Subida al servidor de explotación

1. Accedemos al exploit server.
    
2. Pegamos el exploit HTML en el campo “Body”.
    
3. Click en **Store** para guardarlo.
    
4. Probamos el exploit usando **View exploit**.
    
5. Confirmamos que el cambio de email se realizó correctamente.
    

---

### 4.4 Finalización del laboratorio

Para completarlo:

1. Cambiamos la dirección de email a algo diferente a la nuestra (para demostrar el impacto).
    
2. Pulsamos **Deliver to victim**.
    
3. El laboratorio queda resuelto cuando la aplicación procesa la petición maliciosa.
    

---

## 5. Análisis de impacto

El impacto de una vulnerabilidad CSRF sin defensas puede ser severo cuando afecta a acciones sensibles:

- Cambios de información de perfil
    
- Transferencias de dinero
    
- Modificación de credenciales
    
- Eliminación de recursos
    

La explotación **no requiere interacción consciente del usuario**, lo que lo convierte en un ataque silencioso y eficaz.

---

## 6. Conclusión

Este laboratorio ejemplifica el escenario más básico y grave de CSRF:

- La acción sensible no está protegida.
    
- Basta con forzar al usuario a visitar un recurso controlado.
    
- El navegador envía automáticamente las cookies y la sesión.
    

Este tipo de vulnerabilidad fue muy común históricamente, y dio lugar al desarrollo de múltiples mecanismos de mitigación que estudiaremos en laboratorios posteriores.

---

## 7. Recurso recomendado

Para ampliar el conocimiento sobre CSRF:

- [Visitar recurso web: ionos](https://www.ionos.es/digitalguide/servidores/seguridad/cross-site-request-forgery/)

---
