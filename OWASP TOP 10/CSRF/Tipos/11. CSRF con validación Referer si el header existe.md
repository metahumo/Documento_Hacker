
---

# CSRF con validación del encabezado Referer solo si está presente

## 1. Introducción

En este laboratorio trabajamos con una aplicación web que intenta evitar ataques CSRF utilizando una validación del encabezado HTTP Referer. La funcionalidad vulnerable es el cambio de correo electrónico del usuario autenticado. Nuestra tarea consiste en construir una prueba de concepto que logre cambiar el correo de la víctima explotando un fallo lógico en la validación del encabezado.

[Ver laboratorio Portswigger](https://portswigger.net/web-security/csrf/bypassing-referer-based-defenses/lab-referer-validation-depends-on-header-being-present)

---

## 2. Contexto y fallo de diseño

La protección que implementa la aplicación se basa en validar el origen de la petición mediante el encabezado Referer. Si el encabezado existe y pertenece a un dominio diferente, la petición es rechazada. Esta lógica de defensa se basa en el supuesto de que un atacante no puede falsificar el origen.

El problema aparece cuando la aplicación no contempla el caso en el que el encabezado no está presente. Si lo eliminamos por completo, el servidor acepta la petición sin validar su origen. El diseño asume que la ausencia del encabezado es segura, cuando en realidad es una condición controlable por el atacante.

Esta lógica se puede resumir así:

1. Si el Referer existe y pertenece al dominio esperado, aceptamos.
    
2. Si el Referer existe y pertenece a un dominio diferente, rechazamos.
    
3. Si el Referer no existe, aceptamos.
    

El tercer punto es el fallo crítico que nos permite explotar la aplicación.

---

## 3. Control del Referer desde el navegador

El navegador normalmente envía el encabezado Referer de forma automática, pero HTML ofrece una forma de alterar ese comportamiento, mediante una metaetiqueta especial:

```
<meta name="referrer" content="no-referrer">
```

Al incluir esta metaetiqueta, instruimos al navegador para que no envíe ningún encabezado Referer en las peticiones generadas desde nuestra página. Esto nos permite manipular el flujo sin depender de configuraciones del servidor o del usuario.

Por tanto, nuestra prueba de concepto necesita dos elementos:

1. Un formulario que envíe la petición legítima con los parámetros necesarios.
    
2. La metaetiqueta que suprima el envío automático del encabezado.
    

---

## 4. Análisis de la petición vulnerable

Al capturar la petición en Burp, observamos que:

- Si manipulamos el dominio dentro del encabezado Referer, el servidor la rechaza.
    
- Si eliminamos completamente el encabezado Referer, el servidor la acepta.
    

Esto confirma que el sistema depende exclusivamente de la presencia del encabezado, y que la ausencia se interpreta como válida.

---

## 5. Explotación

La explotación consiste en construir una página HTML que:

1. Establezca la política de referer a no-referrer.
    
2. Incluya un formulario que envíe una petición POST al endpoint vulnerable.
    
3. Rellene automáticamente el formulario con un correo controlado.
    
4. Envíe la petición de forma automática cuando la página cargue.
    

Al enviar esta página a la víctima, su navegador abrirá la página en el exploit server y ejecutará el formulario sin enviar un encabezado Referer. El servidor interpretará la solicitud como válida y actualizará el correo.

---

## 6. Fundamentación del ataque

El ataque funciona porque el servidor confunde dos conceptos:

- Ausencia del encabezado
    
- Origen confiable
    

La ausencia de información no implica confianza. Al aceptar cualquier petición sin encabezado, se abre la puerta a que un atacante elimine ese encabezado de forma deliberada y fuerce la aceptación.

Este patrón es común cuando se aplican validaciones condicionales:

```
si Referer existe:
    comprobar origen
sino:
    aceptar
```

La ausencia del encabezado debe ser tratada como una anomalía, no como una condición segura.

---

## 7. Payload que resuelve el laboratorio

```html
<html>
<head>
    <meta name="referrer" content="no-referrer">
</head>

<form method="POST" action="https://0a04004e0433ca9a80b9030000d500aa.web-security-academy.net/my-account/change-email">
    <input type="hidden" name="email" value="victima@attacker.com">
</form>

<script>
    document.forms[0].submit();
</script>
</html>
```

Cuando la víctima carga el exploit, su navegador envía el formulario sin encabezado Referer y el servidor acepta la petición.

---

## 8. Conclusión

Este laboratorio ilustra cómo una medida de seguridad basada en encabezados HTTP puede ser insuficiente si se implementa de forma incompleta. Validar el Referer solo cuando está presente deja un vector de ataque funcional y fácil de explotar. Además, muestra la importancia de tratar los valores omitidos como potencialmente peligrosos y no como condiciones seguras.

En términos de diseño seguro, el comportamiento esperado sería:

- Rechazar cualquier petición que no incluya encabezado Referer.
    
- Desconfiar de encabezados manipulables por el navegador.
    
- Implementar controles de defensa independientes, como tokens anti-CSRF difícilmente falsificables.
    

---
